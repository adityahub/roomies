<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Immersive Room</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
</head>
<body>
  <a-scene>
    <!-- Asset management system -->
    <a-assets>
      <video id="floorVideo" loop="true"></video>
      <video id="wallVideo1" loop="true"></video>
      <video id="wallVideo2" loop="true"></video>
      <video id="wallVideo3" loop="true"></video>
      <video id="wallVideo4" loop="true"></video>
      <audio id="underwaterSound" loop="true"></audio>
    </a-assets>

    <!-- Floor -->
    <a-video src="#floorVideo" width="10" height="10" position="0 0 0" rotation="-90 0 0"></a-video>

    <!-- Walls -->
    <a-video src="#wallVideo1" width="9" height="6" position="0 3 -4.5" rotation="0 0 0"></a-video>
    <a-video src="#wallVideo2" width="9" height="6" position="4.5 3 0" rotation="0 -90 0"></a-video>
    <a-video src="#wallVideo3" width="9" height="6" position="-4.5 3 0" rotation="0 90 0"></a-video>
    <a-video src="#wallVideo4" width="9" height="6" position="0 3 4.5" rotation="0 180 0"></a-video>

    <!-- User interaction to start videos -->
    <a-entity position="0 1.6 -3">
      <a-plane id="playButton" color="#4CC3D9" width="2" height="1" text="value: Start Videos; align: center" material="shader: flat" class="clickable"></a-plane>
    </a-entity>

    <!-- Laser controls for Oculus Quest interaction -->
    <a-entity laser-controls="hand: right" id="rightHand" raycaster="objects: .clickable"></a-entity>

    <!-- Camera and sound -->
    <a-entity camera look-controls>
      <a-sound src="#underwaterSound" autoplay="true" loop="true"></a-sound>
    </a-entity>
  </a-scene>

  <script>
    function downloadFile(url, key, callback) {
      const cachedFile = localStorage.getItem(key); // Check if file is cached in localStorage

      if (cachedFile) {
        console.log(`Loading ${key} from local storage`);
        callback(cachedFile);  // Use the cached file
      } else {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'blob';
        xhr.onload = function () {
          if (xhr.status === 200) {
            const reader = new FileReader();
            reader.onloadend = function () {
              const fileDataUrl = reader.result;
              localStorage.setItem(key, fileDataUrl);  // Cache the file in local storage
              console.log(`Caching ${key} in local storage`);
              callback(fileDataUrl);  // Return the file data
            };
            reader.readAsDataURL(xhr.response);  // Convert blob to base64 data URL
          }
        };
        xhr.send();
      }
    }

    function loadMedia() {
      const videoFiles = {
        floorVideo: "https://webxrbucketomoi.s3.eu-north-1.amazonaws.com/hf.mp4",
        wallVideo1: "https://webxrbucketomoi.s3.eu-north-1.amazonaws.com/h1.mp4",
        wallVideo2: "https://webxrbucketomoi.s3.eu-north-1.amazonaws.com/h2.mp4",
        wallVideo3: "https://webxrbucketomoi.s3.eu-north-1.amazonaws.com/h4.mp4",
        wallVideo4: "https://webxrbucketomoi.s3.eu-north-1.amazonaws.com/h3.mp4",
        underwaterSound: "https://webxrbucketomoi.s3.eu-north-1.amazonaws.com/FEfinal.mp3"
      };

      Object.keys(videoFiles).forEach(videoId => {
        const url = videoFiles[videoId];
        const videoEl = document.getElementById(videoId);

        // Download or load from cache
        downloadFile(url, videoId, function(fileURL) {
          videoEl.src = fileURL;  // Set the downloaded/cached file as video source
          if (videoId === "underwaterSound") {
            videoEl.play();  // Autoplay sound when loaded
          }
        });
      });
    }

    document.querySelector('#playButton').addEventListener('click', function () {
      const videos = ['floorVideo', 'wallVideo1', 'wallVideo2', 'wallVideo3', 'wallVideo4'];
      videos.forEach(videoId => {
        const video = document.getElementById(videoId);
        video.play();
      });
      this.setAttribute('visible', 'false');

      // Enable bubble generation on trigger press
      const rightHand = document.getElementById('rightHand');
      rightHand.removeAttribute('laser-controls');
      rightHand.setAttribute('bubble-generator', '');
    });

    // Load media on scene load
    document.querySelector('a-scene').addEventListener('loaded', loadMedia);
</script>

</body>
</html>
